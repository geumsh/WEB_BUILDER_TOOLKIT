<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LogViewer Preview</title>
    <style>
        /* === component.css (inline) === */
        #log-viewer-container {
            min-width: 300px;
            min-height: 200px;
        }
        #log-viewer-container .log-viewer {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            background: #1a1f2e;
            border-radius: 8px;
            overflow: hidden;
        }
        #log-viewer-container .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #232a3b;
            border-bottom: 1px solid #2a3142;
        }
        #log-viewer-container .log-title {
            font-size: 14px;
            font-weight: 600;
            color: #e0e6ed;
        }
        #log-viewer-container .log-controls {
            display: flex;
            gap: 8px;
        }
        #log-viewer-container .log-controls button {
            padding: 4px 12px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        #log-viewer-container .btn-clear {
            background: #3b4252;
            color: #e0e6ed;
        }
        #log-viewer-container .btn-clear:hover {
            background: #4c566a;
        }
        #log-viewer-container .btn-scroll {
            background: #4ade80;
            color: #1a1f2e;
        }
        #log-viewer-container .btn-scroll.disabled {
            background: #3b4252;
            color: #8b95a5;
        }
        #log-viewer-container .log-container {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }
        #log-viewer-container .log-list {
            margin: 0;
            padding: 0;
            list-style: none;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }
        #log-viewer-container .log-item {
            display: flex;
            padding: 4px 16px;
            border-bottom: 1px solid #2a3142;
        }
        #log-viewer-container .log-item:hover {
            background: #232a3b;
        }
        #log-viewer-container .log-time {
            color: #8b95a5;
            margin-right: 12px;
            white-space: nowrap;
        }
        #log-viewer-container .log-level {
            width: 50px;
            margin-right: 12px;
            font-weight: 600;
        }
        #log-viewer-container .log-level.info { color: #4ade80; }
        #log-viewer-container .log-level.warn { color: #fbbf24; }
        #log-viewer-container .log-level.error { color: #f87171; }
        #log-viewer-container .log-level.debug { color: #60a5fa; }
        #log-viewer-container .log-message {
            color: #e0e6ed;
            word-break: break-all;
        }

        /* === preview-specific === */
        body {
            margin: 0;
            padding: 40px;
            background: #0d1117;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        h1 { color: #e0e6ed; margin-bottom: 24px; }
        #log-viewer-container { width: 600px; height: 400px; }
        .controls { margin-top: 24px; }
        .controls button {
            padding: 8px 16px;
            margin-right: 8px;
            background: #4ade80;
            color: #1a1f2e;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .controls button.destroy { background: #f87171; }
    </style>
</head>
<body>
    <h1>LogViewer Component Preview</h1>
    <div id="log-viewer-container"></div>
    <div class="controls">
        <button onclick="sendMockData()">Send Initial Data</button>
        <button onclick="addRandomLog()">Add Random Log</button>
        <button onclick="destroy()" class="destroy">Destroy</button>
    </div>

    <script>
        // ======================
        // MOCK CONTEXT
        // ======================

        const mockThis = {
            appendElement: document.getElementById('log-viewer-container')
        };

        // HTML 삽입
        mockThis.appendElement.innerHTML = `
            <div class="log-viewer">
                <div class="log-header">
                    <span class="log-title">-</span>
                    <div class="log-controls">
                        <button class="btn-clear">Clear</button>
                        <button class="btn-scroll">Auto Scroll</button>
                    </div>
                </div>
                <div class="log-container">
                    <ul class="log-list"></ul>
                </div>
            </div>
        `;

        // ======================
        // MOCK DEPENDENCIES
        // ======================

        const GlobalDataPublisher = {
            subscribe: (topic, context, fn) => {
                console.log(`[Mock] subscribe: ${topic}`);
            },
            unsubscribe: (topic, context) => {
                console.log(`[Mock] unsubscribe: ${topic}`);
            }
        };

        const Wkit = {
            bindEvents: (context, events) => {
                console.log('[Mock] bindEvents:', events);
            },
            removeCustomEvents: (context, events) => {
                console.log('[Mock] removeCustomEvents:', events);
            }
        };

        const fx = {
            go: (arr, ...fns) => fns.reduce((acc, fn) => fn(acc), arr),
            each: fn => arr => { arr.forEach(fn); return arr; }
        };

        // ======================
        // REGISTER (scripts/register.js 복사)
        // ======================

        (function register() {
            const { subscribe } = GlobalDataPublisher;
            const { bindEvents } = Wkit;

            const config = {
                titleKey: 'title',
                logsKey: 'logs',
                logFields: {
                    time: 'time',
                    level: 'level',
                    message: 'message'
                },
                maxLogs: 100
            };

            this._autoScroll = true;

            this.renderData = renderData.bind(this, config);
            this.appendLog = appendLog.bind(this, config);
            this.clearLogs = clearLogs.bind(this);
            this.toggleAutoScroll = toggleAutoScroll.bind(this);

            this.subscriptions = {
                mockTopic: ['renderData']
            };

            fx.go(
                Object.entries(this.subscriptions),
                fx.each(([topic, fnList]) =>
                    fx.each(fn => this[fn] && subscribe(topic, this, this[fn]), fnList)
                )
            );

            this.customEvents = {
                click: {
                    '.btn-clear': '@clearClicked',
                    '.btn-scroll': '@scrollToggled'
                }
            };

            bindEvents(this, this.customEvents);

            // 내부 이벤트 핸들러
            setupInternalHandlers.call(this);

            function renderData(config, { response }) {
                const { data } = response;
                if (!data) return;

                const titleEl = this.appendElement.querySelector('.log-title');
                if (titleEl && data[config.titleKey]) {
                    titleEl.textContent = data[config.titleKey];
                }

                const logs = data[config.logsKey];
                if (logs && Array.isArray(logs)) {
                    const listEl = this.appendElement.querySelector('.log-list');
                    listEl.innerHTML = '';
                    logs.forEach(log => appendLogItem.call(this, config, listEl, log));
                    scrollToBottom.call(this);
                }
            }

            function appendLog(config, response) {
                const { data } = response;
                if (!data) return;
                const listEl = this.appendElement.querySelector('.log-list');
                appendLogItem.call(this, config, listEl, data);

                while (listEl.children.length > config.maxLogs) {
                    listEl.removeChild(listEl.firstChild);
                }

                scrollToBottom.call(this);
            }

            function appendLogItem(config, listEl, log) {
                const { logFields } = config;
                const li = document.createElement('li');
                li.className = 'log-item';

                const level = log[logFields.level] || 'info';

                li.innerHTML = `
                    <span class="log-time">${log[logFields.time] || '-'}</span>
                    <span class="log-level ${level}">${level.toUpperCase()}</span>
                    <span class="log-message">${log[logFields.message] || '-'}</span>
                `;

                listEl.appendChild(li);
            }

            function clearLogs() {
                const listEl = this.appendElement.querySelector('.log-list');
                listEl.innerHTML = '';
            }

            function toggleAutoScroll() {
                this._autoScroll = !this._autoScroll;
                const btn = this.appendElement.querySelector('.btn-scroll');
                btn.classList.toggle('disabled', !this._autoScroll);
            }

            function scrollToBottom() {
                if (!this._autoScroll) return;
                const container = this.appendElement.querySelector('.log-container');
                container.scrollTop = container.scrollHeight;
            }

            function setupInternalHandlers() {
                const root = this.appendElement;

                root.querySelector('.btn-clear')?.addEventListener('click', () => this.clearLogs());
                root.querySelector('.btn-scroll')?.addEventListener('click', () => this.toggleAutoScroll());
            }
        }).call(mockThis);

        // ======================
        // BEFORE DESTROY (scripts/beforeDestroy.js 복사)
        // ======================

        function destroy() {
            (function beforeDestroy() {
                const { unsubscribe } = GlobalDataPublisher;
                const { removeCustomEvents } = Wkit;
                const { each } = fx;

                fx.go(
                    Object.entries(this.subscriptions),
                    each(([topic, _]) => unsubscribe(topic, this))
                );
                this.subscriptions = null;

                removeCustomEvents(this, this.customEvents);
                this.customEvents = null;

                this._autoScroll = null;

                this.renderData = null;
                this.appendLog = null;
                this.clearLogs = null;
                this.toggleAutoScroll = null;

                console.log('[LogViewer] destroyed');
            }).call(mockThis);
        }

        // ======================
        // TEST HELPERS
        // ======================

        function sendMockData() {
            mockThis.renderData({
                response: {
                    data: {
                        title: 'System Logs',
                        logs: [
                            { time: '10:23:45', level: 'info', message: 'Application started' },
                            { time: '10:23:46', level: 'warn', message: 'Cache miss' },
                            { time: '10:23:47', level: 'error', message: 'Connection failed' }
                        ]
                    }
                }
            });
        }

        const levels = ['info', 'debug', 'warn', 'error'];
        const messages = [
            'Request processed',
            'Cache updated',
            'Memory usage: 78%',
            'Connection timeout',
            'User authenticated'
        ];

        function addRandomLog() {
            const h = String(Math.floor(Math.random() * 24)).padStart(2, '0');
            const m = String(Math.floor(Math.random() * 60)).padStart(2, '0');
            const s = String(Math.floor(Math.random() * 60)).padStart(2, '0');
            mockThis.appendLog({
                data: {
                    time: `${h}:${m}:${s}`,
                    level: levels[Math.floor(Math.random() * levels.length)],
                    message: messages[Math.floor(Math.random() * messages.length)]
                }
            });
        }

        // 초기 렌더링
        sendMockData();
    </script>
</body>
</html>
