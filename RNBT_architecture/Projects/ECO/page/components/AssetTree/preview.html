<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AssetTree Preview</title>
    <!-- Component CSS -->
    <link rel="stylesheet" href="styles/component.css">
    <style>
        /* Reset & Base */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0f1219;
            padding: 32px;
            display: flex;
            gap: 32px;
        }

        /* Preview Container */
        #asset-tree-container {
            width: 360px;
            height: 600px;
            border: 1px solid #30363d;
            border-radius: 8px;
            overflow: hidden;
        }

        /* Drop Zone (for testing) */
        .drop-zone {
            flex: 1;
            min-width: 300px;
            height: 600px;
            border: 2px dashed #30363d;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            background: #0d1117;
        }

        .drop-zone-header {
            padding: 16px 20px;
            border-bottom: 1px solid #21262d;
            color: #e0e6ed;
            font-size: 16px;
            font-weight: 600;
        }

        .drop-zone-content {
            flex: 1;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #6e7681;
            font-size: 14px;
        }

        .drop-zone.drag-over {
            border-color: #58a6ff;
            background: #1f6feb11;
        }

        .drop-zone.drag-over .drop-zone-content {
            color: #58a6ff;
        }

        .dropped-items {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .dropped-item {
            padding: 12px 16px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 10px;
            color: #e0e6ed;
            font-size: 13px;
        }

        .dropped-item .item-icon {
            font-size: 16px;
        }

        .dropped-item .item-name {
            flex: 1;
        }

        .dropped-item .item-type {
            font-size: 10px;
            padding: 2px 6px;
            background: #30363d;
            color: #8b949e;
            border-radius: 3px;
            text-transform: uppercase;
        }

        .dropped-item .item-remove {
            width: 20px;
            height: 20px;
            border: none;
            background: transparent;
            color: #6e7681;
            cursor: pointer;
            font-size: 14px;
        }

        .dropped-item .item-remove:hover {
            color: #f85149;
        }
    </style>
</head>
<body>
    <!-- Asset Tree Panel -->
    <div id="asset-tree-container">
        <div class="asset-tree-panel">
            <div class="panel-header">
                <h2 class="panel-title">Asset Tree</h2>
                <div class="header-controls">
                    <button class="btn-expand-all" title="Expand All">+</button>
                    <button class="btn-collapse-all" title="Collapse All">-</button>
                </div>
            </div>

            <div class="search-box">
                <input type="text" class="search-input" placeholder="Search assets...">
                <span class="search-icon"></span>
            </div>

            <div class="tree-container">
                <ul class="tree-root"></ul>
            </div>

            <div class="panel-footer">
                <span class="asset-count">
                    <span class="count-label">Total:</span>
                    <span class="count-value">0</span>
                </span>
            </div>
        </div>
    </div>

    <!-- Drop Zone (for testing drag & drop) -->
    <div class="drop-zone" id="drop-zone">
        <div class="drop-zone-header">Layer (Drop Zone)</div>
        <div class="drop-zone-content">
            <div class="dropped-items" id="dropped-items"></div>
            <p id="drop-hint">Drag assets here</p>
        </div>
    </div>

    <!-- Mock Data -->
    <script>
        const MOCK_DATA = {
            items: [
                {
                    id: "building-001",
                    name: "Î≥∏Í¥Ä",
                    type: "building",
                    canHaveChildren: true,
                    status: "warning",
                    children: [
                        {
                            id: "floor-001-01",
                            name: "1Ï∏µ",
                            type: "floor",
                            canHaveChildren: true,
                            status: "warning",
                            children: [
                                {
                                    id: "room-001-01-01",
                                    name: "ÏÑúÎ≤ÑÏã§ A",
                                    type: "room",
                                    canHaveChildren: true,
                                    status: "warning",
                                    children: [
                                        {
                                            id: "rack-001",
                                            name: "Rack-A",
                                            type: "rack",
                                            canHaveChildren: true,
                                            status: "normal",
                                            children: [
                                                { id: "srv-001", name: "Server-1", type: "server", canHaveChildren: false, status: "normal" },
                                                { id: "srv-002", name: "Server-2", type: "server", canHaveChildren: false, status: "normal" },
                                                { id: "srv-003", name: "Server-3", type: "server", canHaveChildren: false, status: "warning" }
                                            ]
                                        },
                                        {
                                            id: "pdu-001",
                                            name: "PDU-A",
                                            type: "pdu",
                                            canHaveChildren: true,
                                            status: "normal",
                                            children: [
                                                { id: "dev-001", name: "Device-1", type: "device", canHaveChildren: false, status: "normal" }
                                            ]
                                        },
                                        { id: "ups-001", name: "UPS-A", type: "ups", canHaveChildren: false, status: "warning" },
                                        { id: "sensor-001", name: "Sensor-1", type: "sensor", canHaveChildren: false, status: "normal" }
                                    ]
                                },
                                {
                                    id: "room-001-01-02",
                                    name: "ÏÑúÎ≤ÑÏã§ B",
                                    type: "room",
                                    canHaveChildren: true,
                                    status: "normal",
                                    children: [
                                        { id: "ups-002", name: "UPS-B", type: "ups", canHaveChildren: false, status: "normal" },
                                        { id: "crac-001", name: "CRAC-A", type: "crac", canHaveChildren: false, status: "normal" }
                                    ]
                                }
                            ]
                        },
                        {
                            id: "floor-001-02",
                            name: "2Ï∏µ",
                            type: "floor",
                            canHaveChildren: true,
                            status: "normal",
                            children: [
                                {
                                    id: "room-001-02-01",
                                    name: "ÌÜµÏã†Ïã§",
                                    type: "room",
                                    canHaveChildren: true,
                                    status: "normal",
                                    children: [
                                        { id: "sensor-002", name: "Sensor-2", type: "sensor", canHaveChildren: false, status: "normal" }
                                    ]
                                }
                            ]
                        }
                    ]
                },
                {
                    id: "building-002",
                    name: "Î≥ÑÍ¥Ä",
                    type: "building",
                    canHaveChildren: true,
                    status: "critical",
                    children: [
                        {
                            id: "floor-002-01",
                            name: "1Ï∏µ",
                            type: "floor",
                            canHaveChildren: true,
                            status: "critical",
                            children: [
                                {
                                    id: "room-002-01-01",
                                    name: "Îç∞Ïù¥ÌÑ∞ÏÑºÌÑ∞",
                                    type: "room",
                                    canHaveChildren: true,
                                    status: "critical",
                                    children: [
                                        {
                                            id: "rack-002",
                                            name: "Rack-B",
                                            type: "rack",
                                            canHaveChildren: true,
                                            status: "critical",
                                            children: [
                                                { id: "srv-004", name: "Server-4", type: "server", canHaveChildren: false, status: "critical" },
                                                { id: "srv-005", name: "Server-5", type: "server", canHaveChildren: false, status: "normal" }
                                            ]
                                        },
                                        { id: "ups-003", name: "UPS-C", type: "ups", canHaveChildren: false, status: "normal" }
                                    ]
                                }
                            ]
                        }
                    ]
                }
            ]
        };

        // Icon map
        const ICON_MAP = {
            building: 'üè¢',
            floor: 'üìÇ',
            room: 'üö™',
            rack: 'üì¶',
            pdu: 'üîå',
            ups: '‚ö°',
            crac: '‚ùÑÔ∏è',
            sensor: 'üå°Ô∏è',
            server: 'üíª',
            device: 'üìü'
        };
    </script>

    <!-- Render Logic -->
    <script>
        const container = document.getElementById('asset-tree-container');
        const panel = container.querySelector('.asset-tree-panel');
        const dropZone = document.getElementById('drop-zone');
        const droppedItems = document.getElementById('dropped-items');
        const dropHint = document.getElementById('drop-hint');

        // State
        let treeData = null;
        let flatData = [];
        let expandedNodes = new Set();
        let selectedNodeId = null;
        let searchTerm = '';
        let matchedIds = new Set();
        let pathIds = new Set();
        let droppedAssets = [];

        // ==================
        // FLATTEN TREE
        // ==================
        function flattenTree(items, parent = null, result = []) {
            items.forEach(item => {
                result.push({ ...item, parentId: parent?.id || null });
                if (item.children && item.children.length > 0) {
                    flattenTree(item.children, item, result);
                }
            });
            return result;
        }

        // ==================
        // TREE RENDERING
        // ==================
        function renderTree(data) {
            treeData = data.items;
            flatData = flattenTree(data.items);
            renderTreeNodes(treeData, searchTerm);
            updateCount();
            console.log('[Preview] Tree rendered:', flatData.length, 'assets');
        }

        function renderTreeNodes(items, term = '') {
            const rootEl = panel.querySelector('.tree-root');
            if (!rootEl) return;

            rootEl.innerHTML = '';
            const normalized = term.toLowerCase().trim();

            // Í≤ÄÏÉâ Îß§Ïπ≠ Í≥ÑÏÇ∞
            if (normalized) {
                matchedIds = new Set();
                pathIds = new Set();

                flatData.forEach(asset => {
                    if (asset.name.toLowerCase().includes(normalized)) {
                        matchedIds.add(asset.id);
                        collectAncestorIds(asset.id);
                    }
                });
            } else {
                matchedIds.clear();
                pathIds.clear();
            }

            // Í≤∞Í≥º ÏóÜÏùå
            if (normalized && matchedIds.size === 0) {
                rootEl.innerHTML = '<div class="no-results">No matching assets found</div>';
                return;
            }

            items.forEach(item => {
                const nodeEl = createTreeNode(item, normalized);
                if (nodeEl) rootEl.appendChild(nodeEl);
            });
        }

        function collectAncestorIds(assetId) {
            const asset = flatData.find(a => a.id === assetId);
            if (!asset || !asset.parentId) return;
            pathIds.add(asset.parentId);
            collectAncestorIds(asset.parentId);
        }

        function createTreeNode(item, term) {
            const { id, name, type, status, canHaveChildren, children = [] } = item;
            const hasChildren = children.length > 0;
            const isExpanded = expandedNodes.has(id);
            const isSelected = selectedNodeId === id;
            const isMatch = matchedIds.has(id);
            const isPath = pathIds.has(id);

            // Í≤ÄÏÉâ Ïãú ÌïÑÌÑ∞ÎßÅ
            if (term && !isMatch && !isPath && !hasMatchingDescendants(item)) {
                return null;
            }

            const li = document.createElement('li');
            li.className = 'tree-node';
            li.dataset.nodeId = id;
            li.dataset.nodeType = type;
            li.dataset.canHaveChildren = canHaveChildren;

            const content = document.createElement('div');
            content.className = 'node-content';
            content.draggable = true;

            if (isSelected) content.classList.add('selected');
            if (isMatch) content.classList.add('match');
            if (term && !isMatch && !isPath) content.classList.add('dimmed');

            // Toggle
            const toggle = document.createElement('span');
            toggle.className = 'node-toggle';
            if (hasChildren) {
                toggle.textContent = '‚ñ∂';
                if (isExpanded || (term && (isPath || isMatch))) {
                    toggle.classList.add('expanded');
                }
            } else {
                toggle.classList.add('leaf');
            }

            // Icon
            const icon = document.createElement('span');
            icon.className = 'node-icon';
            icon.dataset.type = type;

            // Label
            const label = document.createElement('span');
            label.className = 'node-label';
            label.textContent = name;

            // Type tag
            const typeTag = document.createElement('span');
            typeTag.className = 'node-type';
            typeTag.textContent = type;
            typeTag.dataset.container = canHaveChildren;

            content.appendChild(toggle);
            content.appendChild(icon);
            content.appendChild(label);
            content.appendChild(typeTag);

            // Status
            if (status) {
                const statusDot = document.createElement('span');
                statusDot.className = `node-status ${status}`;
                content.appendChild(statusDot);
            }

            // Drag handle
            const dragHandle = document.createElement('span');
            dragHandle.className = 'node-drag-handle';
            content.appendChild(dragHandle);

            li.appendChild(content);

            // Children
            if (hasChildren) {
                const childrenUl = document.createElement('ul');
                childrenUl.className = 'node-children';
                if (isExpanded || (term && (isPath || isMatch))) {
                    childrenUl.classList.add('expanded');
                }

                children.forEach(child => {
                    const childEl = createTreeNode(child, term);
                    if (childEl) childrenUl.appendChild(childEl);
                });

                li.appendChild(childrenUl);
            }

            return li;
        }

        function hasMatchingDescendants(item) {
            if (!item.children) return false;
            return item.children.some(child => {
                if (matchedIds.has(child.id)) return true;
                return hasMatchingDescendants(child);
            });
        }

        // ==================
        // NODE ACTIONS
        // ==================
        function toggleNode(nodeId) {
            if (expandedNodes.has(nodeId)) {
                expandedNodes.delete(nodeId);
            } else {
                expandedNodes.add(nodeId);
            }
            updateNodeVisuals(nodeId);
        }

        function selectNode(nodeId) {
            const prev = panel.querySelector('.node-content.selected');
            if (prev) prev.classList.remove('selected');

            selectedNodeId = nodeId;

            const nodeEl = panel.querySelector(`[data-node-id="${nodeId}"] > .node-content`);
            if (nodeEl) nodeEl.classList.add('selected');
        }

        function expandAll() {
            collectAllNodeIds(treeData);
            renderTreeNodes(treeData, searchTerm);
        }

        function collapseAll() {
            expandedNodes.clear();
            renderTreeNodes(treeData, searchTerm);
        }

        function collectAllNodeIds(items) {
            if (!items) return;
            items.forEach(item => {
                if (item.children && item.children.length > 0) {
                    expandedNodes.add(item.id);
                    collectAllNodeIds(item.children);
                }
            });
        }

        function updateNodeVisuals(nodeId) {
            const nodeEl = panel.querySelector(`[data-node-id="${nodeId}"]`);
            if (!nodeEl) return;

            const toggle = nodeEl.querySelector(':scope > .node-content > .node-toggle');
            const children = nodeEl.querySelector(':scope > .node-children');
            const isExpanded = expandedNodes.has(nodeId);

            if (toggle) toggle.classList.toggle('expanded', isExpanded);
            if (children) children.classList.toggle('expanded', isExpanded);
        }

        function updateCount() {
            const countEl = panel.querySelector('.count-value');
            if (countEl) countEl.textContent = flatData.length;
        }

        // ==================
        // SEARCH
        // ==================
        function search(term) {
            searchTerm = term;
            renderTreeNodes(treeData, term);
        }

        // ==================
        // DRAG & DROP
        // ==================
        function findAssetById(id) {
            return flatData.find(a => a.id === id) || null;
        }

        function addDroppedAsset(asset) {
            // Ï§ëÎ≥µ Ï≤¥ÌÅ¨
            if (droppedAssets.some(a => a.id === asset.id)) {
                console.log('[Preview] Asset already added:', asset.name);
                return;
            }

            droppedAssets.push(asset);
            renderDroppedItems();
            dropHint.style.display = 'none';
            console.log('[Preview] Asset added:', asset.name);
        }

        function removeDroppedAsset(assetId) {
            droppedAssets = droppedAssets.filter(a => a.id !== assetId);
            renderDroppedItems();
            if (droppedAssets.length === 0) {
                dropHint.style.display = 'block';
            }
        }

        function renderDroppedItems() {
            droppedItems.innerHTML = '';
            droppedAssets.forEach(asset => {
                const item = document.createElement('div');
                item.className = 'dropped-item';
                item.innerHTML = `
                    <span class="item-icon">${ICON_MAP[asset.type] || 'üìÑ'}</span>
                    <span class="item-name">${asset.name}</span>
                    <span class="item-type">${asset.type}</span>
                    <button class="item-remove" data-id="${asset.id}">√ó</button>
                `;
                droppedItems.appendChild(item);
            });
        }

        // ==================
        // EVENT HANDLERS
        // ==================
        function setupEventHandlers() {
            // Tree click
            panel.querySelector('.tree-container')?.addEventListener('click', (e) => {
                const nodeContent = e.target.closest('.node-content');
                if (!nodeContent) return;

                const nodeEl = nodeContent.closest('.tree-node');
                if (!nodeEl) return;

                const nodeId = nodeEl.dataset.nodeId;
                const toggle = nodeContent.querySelector('.node-toggle');

                if (e.target.closest('.node-toggle') && !toggle.classList.contains('leaf')) {
                    toggleNode(nodeId);
                } else {
                    selectNode(nodeId);
                }
            });

            // Search
            panel.querySelector('.search-input')?.addEventListener('input', (e) => {
                search(e.target.value);
            });

            // Expand/Collapse
            panel.querySelector('.btn-expand-all')?.addEventListener('click', expandAll);
            panel.querySelector('.btn-collapse-all')?.addEventListener('click', collapseAll);

            // Drag start
            panel.querySelector('.tree-container')?.addEventListener('dragstart', (e) => {
                const nodeContent = e.target.closest('.node-content');
                if (!nodeContent) return;

                const nodeEl = nodeContent.closest('.tree-node');
                if (!nodeEl) return;

                const asset = findAssetById(nodeEl.dataset.nodeId);
                if (!asset) return;

                nodeContent.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'copy';
                e.dataTransfer.setData('application/json', JSON.stringify(asset));
                e.dataTransfer.setData('text/plain', asset.name);

                console.log('[Preview] Drag start:', asset.name);
            });

            // Drag end
            panel.querySelector('.tree-container')?.addEventListener('dragend', (e) => {
                const nodeContent = e.target.closest('.node-content');
                if (nodeContent) {
                    nodeContent.classList.remove('dragging');
                }
            });

            // Drop zone
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', (e) => {
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');

                try {
                    const assetData = e.dataTransfer.getData('application/json');
                    if (assetData) {
                        const asset = JSON.parse(assetData);
                        addDroppedAsset(asset);
                    }
                } catch (err) {
                    console.error('[Preview] Drop error:', err);
                }
            });

            // Remove dropped item
            droppedItems.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.item-remove');
                if (removeBtn) {
                    const assetId = removeBtn.dataset.id;
                    removeDroppedAsset(assetId);
                }
            });
        }

        // ==================
        // INIT
        // ==================
        window.onload = () => {
            setupEventHandlers();
            renderTree(MOCK_DATA);
        };
    </script>
</body>
</html>
